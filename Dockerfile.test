# Build test image for running integration tests
#
# This Dockerfile uses a multi-stage build to create a container with
# both the Nix-built isolate/runtime and a Rust nightly toolchain for
# compiling and running the test suite.
#
# Usage:
#    docker build -f Dockerfile.test -t silicube-test:latest .
#    docker run --rm --privileged silicube-test:latest
#
# Note: Tests require --privileged because isolate uses Linux namespaces
# and cgroups.

# Stage 1: Build isolate and runtime environment via Nix
FROM nixos/nix:2.33.2 AS nix-builder

RUN mkdir -p /etc/nix && \
    echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf

WORKDIR /build
COPY . .

RUN nix build .#isolate --out-link /build/isolate
RUN nix build .#runtimeEnv --out-link /build/runtime

# Copy the closure of all required store paths
RUN mkdir -p /output/nix/store /output/bin && \
    nix copy --to /output --no-check-sigs \
        $(nix path-info .#isolate) \
        $(nix path-info .#runtimeEnv)

# Create convenience symlinks
RUN ln -s $(nix path-info .#isolate)/bin/* /output/bin/ && \
    for pkg in $(nix path-info .#runtimeEnv)/bin/*; do \
        ln -sf "$pkg" /output/bin/ 2>/dev/null || true; \
    done

# Stage 2: Test runner with Rust nightly
FROM rustlang/rust:nightly-bookworm AS test-runner

# Copy Nix store and convenience symlinks from builder
COPY --from=nix-builder /output/nix/store /nix/store
COPY --from=nix-builder /output/bin /app/bin

# Make Nix-built tools available
ENV PATH="/app/bin:$PATH"

# Create directories required by isolate:
# - /var/local/lib/isolate: box root for sandbox data
# - /usr, /lib: isolate's built-in defaults bind-mount these from the host;
#   the base image already has them, but ensure they exist
RUN mkdir -p /var/local/lib/isolate

WORKDIR /build

# Copy manifests first for dependency caching
COPY Cargo.toml Cargo.lock rustfmt.toml ./
COPY crates/silicube/Cargo.toml crates/silicube/Cargo.toml
COPY crates/silicube-cli/Cargo.toml crates/silicube-cli/Cargo.toml

# Create stub lib/main files so cargo fetch works
RUN mkdir -p crates/silicube/src crates/silicube-cli/src && \
    echo "fn main() {}" > crates/silicube-cli/src/main.rs && \
    touch crates/silicube/src/lib.rs

RUN cargo fetch

# Copy full source (invalidates cache only when source changes)
COPY . .

CMD ["cargo", "test", "-p", "silicube", "--features", "integration-tests", "--", "--include-ignored"]
